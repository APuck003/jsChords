<html>
<head>
    <script type='text/javascript' src='../jschords-src.js'></script>
<script>
    // Define the set of test frequencies that we'll use to analyze microphone data.
    var test_frequencies = C.getAllFreq();
    var correlation_worker,audio;
    var data;
    var allTimesMax =-10;
    var MSSAMPLE = 100;
    var CONFTHRES = 10;
    var SIGNALAMP = 0;
    
    window.addEventListener("load", onLoad);
    
    function onLoad()
    {
	audio = new C.Audio({
	    success: use_stream
	});
	correlation_worker = new Worker("tunerWorker.js");
	correlation_worker.addEventListener("message", interpret_correlation_result);
	vis(C.DomUtil.get("canvasF"))
	visAnal(C.DomUtil.get("canvasA"))
    }
    
    
    function use_stream(stream)
    {
	    var audio_context = audio.getCtx();
	    var minBufLen = MSSAMPLE * audio_context.sampleRate / 1000
	    var microphone = audio_context.createMediaStreamSource(stream);
	    var script_processor = audio_context.createScriptProcessor(1024, 1, 1);
	    script_processor.connect(audio_context.destination);
	    microphone.connect(script_processor);
	    
	    var buffer = [];
	    var recording = true;
	    // Need to leak this function into the global namespace so it doesn't get
	    // prematurely garbage-collected.
	    // http://lists.w3.org/Archives/Public/public-audio/2013JanMar/0304.html
	    window.capture_audio = function(event)
	    {
		    if (!recording)
			    return;
		    buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));
		    // Stop recording after MSSAMPLE.
		    if (buffer.length > minBufLen)
		    {
			    recording = false;
			    correlation_worker.postMessage
			    (
				    {
					    "timeseries": buffer,
					    "test_frequencies": test_frequencies,
					    "sample_rate": audio_context.sampleRate
				    }
			    );
			    
			    buffer = [];
			    // Urban: sliding window ?? Keep middle values...?!
// 			    buffer=buffer.splice(minBufLen/1.5);
			    
			    setTimeout(function() { recording = true; }, 250);
		    }
	    };
	    script_processor.onaudioprocess = window.capture_audio;
    }
    
    
    
    function interpret_correlation_result(event)
    {
	    data = event.data;
	    var timeseries = data.timeseries;
	    var frequency_amplitudes = data.frequency.amplitudes;
	    var magnitudes = data.frequency.magnitudes;
	    
	    
// 	    var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
	    var fstats = data.frequency.stats;
	    
	    
	    var confidence = fstats.max / fstats.avgM;
// 	    if (confidence>CONFTHRES) lg(confidence,fstats.max,fstats.avgM)
	    if (confidence > CONFTHRES && data.time.stats.amp > SIGNALAMP)
	    {
		var dominant_frequency = test_frequencies[fstats.maxIdx];
		document.getElementById("note-name").textContent = dominant_frequency.name;
		document.getElementById("frequency").textContent = dominant_frequency.frequency;
		document.getElementById("avgf").textContent = fstats.avgF;
		
// 		var absDiff = Math.abs(fstats.avgF-dominant_frequency.frequency);
		var absDiff = C.getFreqOffset(dominant_frequency.frequency, fstats.avgF);
		lg(absDiff)
		// FIXME: calc note spacing!
		if (absDiff<0.3)
		    document.getElementById("dir").textContent = "O";
		else if (fstats.avgF<dominant_frequency.frequency) 
		    document.getElementById("dir").textContent = "<";
		else 
		    document.getElementById("dir").textContent = ">";
			
	    }
	    
	    /*if (allTimesMax<fstats.max) */allTimesMax=fstats.max;
	    
	    C.DomUtil.get("ddata").innerHTML = JSON.stringify(data.frequency.stats)+
					    "<br/>"+JSON.stringify(data.time.stats);
    }
    
    
    function vis(el){
	var WIDTH = el.width;
	var HEIGHT = el.height;

	var canvasCtx = el.getContext("2d");
	canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
	
	
	function draw() {
	    drawVisual = requestAnimationFrame(draw);
	    var magnitudes = ( data ) ? data.frequency.magnitudes : false;
	    if (!magnitudes) return;
	    

	    canvasCtx.fillStyle = 'rgb(0, 0, 0)';
	    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

	    var barWidth = (WIDTH / magnitudes.length)-1;
	    var barHeight;
	    var x = 0;
	    for(var i = 0; i < magnitudes.length; i++) {
		if (magnitudes[i]==0) continue;
		    barHeight = magnitudes[i]/allTimesMax*HEIGHT;

		canvasCtx.fillStyle = 'red';
		canvasCtx.fillRect(x,HEIGHT-barHeight,barWidth,barHeight);

		x += barWidth + 1;
	    }
	};

	draw();
    }
    
        
    function visAnal(el){
	var WIDTH = el.width;
	var HEIGHT = el.height;

	var canvasCtx = el.getContext("2d");
	canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
	


	function draw2() {
	    requestAnimationFrame(draw2);
	    var dataAnalog = ( data ) ? data.timeseries : false;
	    if (!dataAnalog) return;

	    canvasCtx.fillStyle = 'rgb(200, 200, 200)';
	    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

	    canvasCtx.lineWidth = 1;
	    canvasCtx.strokeStyle = 'rgb(0, 0, 0)';

	    canvasCtx.beginPath();

	    var sliceWidth = WIDTH * 1.0 / dataAnalog.length;
	    var x = 0;

	    for(var i = 0; i < dataAnalog.length; i++) {
	
		var v = dataAnalog[i]*10;
		var y = v * HEIGHT/2 + HEIGHT/2;

		if(i === 0) {
		    canvasCtx.moveTo(x, y);
		} else {
		    canvasCtx.lineTo(x, y);
		}

		x += sliceWidth;
	    }

	    canvasCtx.lineTo(WIDTH, HEIGHT/2);
	    canvasCtx.stroke();
	};

	draw2();
    }
    
// Unnecessary addition of button to play an E note.
var note_context = new AudioContext();
var note_node = note_context.createOscillator();
var gain_node = note_context.createGain();
note_node.frequency.value = C.Note.F["E4"]; // E, ~82.41 Hz.
gain_node.gain.value = 0;
note_node.connect(gain_node);
gain_node.connect(note_context.destination);
note_node.start();
var playing = false;
function toggle_playing_note()
{
	lg(note_node.frequency.value)
	playing = !playing;
	if (playing)
		gain_node.gain.value = 0.5;
	else
		gain_node.gain.value = 0;
}
</script>
</head>

<body>
<p>It sounds like you're playing...</p>
<h1 id="note-name"></h1>
<span id="dir"></span>
<p>
	<span>Note Frequency:</span>
	<span id="frequency"></span>
	<span> Current:</span>
	<span id="avgf"></span>
</p>
<p>
    <canvas id="canvasF" style="width:500px; height: 80px;"></canvas>
    <br/>
    <canvas id="canvasA" style="width:500px; height: 80px;"></canvas>
    <div id='ddata'></div>
</p>
<hr>
<button id="play-note" onclick='toggle_playing_note()'>start/stop note</button>
</body>
</html>
 
